# 数据格式说明

本文档详细说明了出租车司机异常行为检测系统所需的数据格式和结构。

## 📊 输入数据格式

### 1. POI数据文件

**文件路径**: `poi_path`  
**格式**: 文本文件（.txt）  
**编码**: UTF-8

#### 数据格式
```
站点坐标,POI类型和数量
103.94,30.78,生活服务:5|教育培训:2|交通设施:1;住宅区
104.12,30.85,美食:3|酒店:1|购物:4;公司
...
```

#### 字段说明
- **站点坐标**: `经度,纬度` 格式
- **POI类型**: 用`|`分隔的POI类型和数量，格式为`类型:数量`
- **POI种类**: 用`;`分隔的POI种类信息

#### 支持的POI类型
```
生活服务, 教育培训, 交通设施, 汽车服务, 道路, 休闲娱乐, 
文化传媒, 丽人, 房地产, 美食, 酒店, 公司企业, 购物, 
政府机构, 金融, 医疗, 旅游景点, 运动健身, 自然地物, 
铁路, 公交线路
```

#### 示例数据
```
103.94,30.78,生活服务:5|教育培训:2|交通设施:1;住宅区
104.12,30.85,美食:3|酒店:1|购物:4;公司
103.88,30.92,医疗:2|金融:1;银行
```

### 2. 司机订单数据文件

**文件路径**: `driver_order_path`  
**格式**: 文本文件（.txt）  
**编码**: UTF-8

#### 数据格式
```
司机ID,订单ID,上车时间戳,下车时间戳,上车经度,上车纬度,下车经度,下车纬度
driver_001,order_001,1478016000,1478017200,103.94,30.78,104.12,30.85
driver_001,order_002,1478017800,1478019000,104.12,30.85,103.88,30.92
...
```

#### 字段说明
- **司机ID**: 唯一标识司机的字符串
- **订单ID**: 唯一标识订单的字符串
- **上车时间戳**: Unix时间戳（秒）
- **下车时间戳**: Unix时间戳（秒）
- **上车经度**: 上车点经度坐标
- **上车纬度**: 上车点纬度坐标
- **下车经度**: 下车点经度坐标
- **下车纬度**: 下车点纬度坐标

#### 示例数据
```
driver_001,order_001,1478016000,1478017200,103.94,30.78,104.12,30.85
driver_001,order_002,1478017800,1478019000,104.12,30.85,103.88,30.92
driver_002,order_003,1478018400,1478019600,103.88,30.92,103.95,30.80
```

### 3. 真实标签数据文件

**文件路径**: `ground_truth_path`  
**格式**: Excel文件（.xlsx）

#### 数据格式
| 列名 | 类型 | 说明 |
|------|------|------|
| ID | 整数 | 记录ID |
| 经度 | 浮点数 | 异常点经度 |
| 纬度 | 浮点数 | 异常点纬度 |
| 标签 | 整数 | 异常标签（1=异常，0=正常） |

#### 示例数据
```
ID,经度,纬度,标签
1,103.94,30.78,1
2,104.12,30.85,0
3,103.88,30.92,1
```

## 🔧 数据预处理

### 网格化处理

系统将地理坐标转换为网格坐标：

```python
def get_coordinate(lon, lat, grid_granularity):
    """
    将经纬度坐标转换为网格坐标
    
    参数:
        lon: 经度
        lat: 纬度  
        grid_granularity: 网格粒度（米）
    
    返回:
        (x, y): 网格坐标
    """
```

### 边界过滤

系统会过滤掉边界外的数据点：

```python
# 默认边界设置
poi_boundary = [-28, -75, 73, 29]  # [min_x, min_y, max_x, max_y]
```

### 时间冲突检测

系统会检测并移除时间冲突的订单：

```python
# 检查订单时间逻辑
if order[2] < drop_off_hour:  # 新订单开始时间 < 前订单结束时间
    # 标记为时间冲突
```

## 📁 输出数据格式

### 1. 特征数据

**格式**: Python列表  
**维度**: `[节点数, 特征维度]`

```python
features = [
    [poi_feature_1, poi_feature_2, ..., driver_feature_1, driver_feature_2, ...],
    [poi_feature_1, poi_feature_2, ..., driver_feature_1, driver_feature_2, ...],
    ...
]
```

### 2. 邻接矩阵

**格式**: 字典  
**结构**: `{节点ID: {邻居节点ID: 权重}}`

```python
adjacency = {
    0: {1: 1.0, 2: 0.5},
    1: {0: 1.0, 3: 0.8},
    2: {0: 0.5, 3: 1.0},
    ...
}
```

### 3. 标签数据

**格式**: Python列表  
**值**: 0（正常）或1（异常）

```python
labels = [0, 1, 0, 1, 0, ...]
```

## 🗂️ 数据目录结构

```
data/
├── model/                          # 模型文件
│   ├── best_model_multi_cluster.pth # 多聚类最佳模型
│   ├── best_model_new.pth          # 单模型最佳模型
│   ├── features.pt                # 特征数据
│   ├── labels.pt                   # 标签数据
│   ├── adj_matrix.npz              # 邻接矩阵
│   ├── train_idx.npy              # 训练集索引
│   ├── val_idx.npy                # 验证集索引
│   └── test_idx.npy                # 测试集索引
├── similarity_matrix/               # 相似度矩阵
│   ├── similarity_matrix_1001_-71_-71_92_123.pkl
│   └── ...
├── augmented_data_v2/              # 增强数据
│   └── augmented_data_1001_-28_-75_73_29.pkl
└── cluster_data_cache_v2.pkl        # 聚类数据缓存
```

## 📊 数据统计信息

### 典型数据规模

- **POI数据**: 约10,000个兴趣点
- **司机数据**: 约1,000个司机，每个司机平均50个订单
- **网格大小**: 500m × 500m
- **特征维度**: 782维（22维POI特征 + 760维司机轨迹特征）

### 内存使用

- **特征矩阵**: 约100MB
- **邻接矩阵**: 约50MB
- **缓存数据**: 约200MB

## 🔍 数据质量检查

### 必需检查项

1. **坐标范围检查**
   ```python
   # 检查坐标是否在合理范围内
   assert -180 <= lon <= 180
   assert -90 <= lat <= 90
   ```

2. **时间戳检查**
   ```python
   # 检查时间戳是否合理
   assert pickup_time < dropoff_time
   ```

3. **数据完整性检查**
   ```python
   # 检查必要字段是否存在
   required_fields = ['driver_id', 'order_id', 'pickup_time', 'dropoff_time']
   ```

### 数据清洗

1. **移除重复数据**
2. **处理缺失值**
3. **异常值检测和修正**
4. **数据格式标准化**

## 📝 数据使用示例

```python
# 加载数据
poi_path = 'data/poi_data.txt'
driver_order_path = 'data/driver_orders.txt'
ground_truth_path = 'data/ground_truth.xlsx'
grid_granularity = 500

# 数据预处理
features_by_cluster, adjs_by_cluster, labels_by_cluster, driver_clusters, cluster_boundaries = data_prepare(
    poi_path, driver_order_path, ground_truth_path, grid_granularity
)

# 检查数据质量
print(f"聚类数量: {len(features_by_cluster)}")
print(f"特征维度: {features_by_cluster[list(features_by_cluster.keys())[0]].shape}")
print(f"标签分布: {np.bincount(labels_by_cluster[list(labels_by_cluster.keys())[0]])}")
```

## ⚠️ 注意事项

1. **数据隐私**: 确保遵守当地数据隐私法规
2. **数据安全**: 敏感数据应加密存储
3. **数据备份**: 定期备份重要数据
4. **版本控制**: 使用版本控制管理数据变更

## 🆘 常见问题

### Q: 数据格式不正确怎么办？
A: 检查文件编码、分隔符和字段顺序，确保符合格式要求。

### Q: 内存不足怎么办？
A: 使用数据压缩、分批处理或增加系统内存。

### Q: 数据加载速度慢怎么办？
A: 使用缓存机制、数据预处理和并行处理。

### Q: 如何处理缺失数据？
A: 根据业务逻辑进行插值、删除或标记处理。
